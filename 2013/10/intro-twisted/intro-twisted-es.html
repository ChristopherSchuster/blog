Introducci√≥n a Twisted Framework

<p>Twisted es un framework escrito en python orientado a eventos que permite implemntar sistemas 
as&iacute;ncronos. En el  <a href="http://twistedmatrix.com/trac/">sitio web del proyecto</a> se puede encontrar
mucha informaci&oacute;n. Este post muestra un ejemplo muy b&aacute;sico basado en esta documentaci&oacute;n
</p>

<h3>Ejemplo de servidor Time UUID </h3>

<p>Supongamos que tenemos un sistema distribuido donde tenemos varios servidores de aplicaciones que comparten
un mismo cluster de base de datos, las llaves primarias de algunas tablas necesitan una llave primaria secuencial
y &uacute;nica basada en  <a href="http://en.wikipedia.org/wiki/Universally_unique_identifier"> Universally unique identifier UUID</a> por lo tanto decidimos implementar un servicio que nos dara estos identificadores:
</p>

<img class="img-polaroid" src="https://raw.github.com/maigfrga/blog/master/2013/10/intro-twisted/timeuuidsystem.png" />

<h3>El servidor</h3>

<h4>El Protocolo</h4>

<p>El principal objecti es implementar un protocolo de red que interactue con servidores TCP, este protocolo 
es una subclase de  <a href="http://twistedmatrix.com/documents/13.1.0/api/twisted.internet.protocol.Protocol.html">twisted.internet.protocol.Protocol</a>. Una instancia de esta clase es instanciada por conecci&oacute;n y se 
elimina cuando la petici&oacute;n finaliza, las opciones de configuraci&oacute;n no son almacenadas en el 
protocolo.</p>

<pre>
    from twisted.internet import reactor
    from twisted.internet.protocol import Factory
    from twisted.protocols.basic import LineReceiver

    import datetime, time_uuid

    class TimeUUId(LineReceiver):
        def __init__(self):
            self.options = {'C': self.handle_GETUUID, 'X': self.handle_CLOSE}

        def connectionMade(self):
            message = """
                      Welcome to Time UUID generator :-)\r\n
                      press C to get a time UUID
                      press X to exit
                      """
            self.transport.write(message)

        def lineReceived(self, line):
            if line.upper() in self.options:
                self.options[line.upper()]()
            else:
                self.transport.write('Invalid option :-( \n')

        def handle_CLOSE(self):
            self.transport.write('good bye :-) \n')
            self.transport.loseConnection()

        def handle_GETUUID(self):
            uuid =time_uuid.TimeUUID.with_utc(datetime.datetime.utcnow())
            self.transport.write(str(uuid))

</pre>

<h4>Factory</h4>

<p>Un objetivo de dise&ntilde;o debe ser la posibilidad de exponer este servicio en m&uacute;ltiples puertos or
direcciones de red. Es por esta raz&oacute;n que los detalles de configuraci&oacute;n se definen en una clase
Factory que es subclase de <a href="http://twistedmatrix.com/documents/13.1.0/api/twisted.internet.protocol.Factory.html">twisted.internet.protocol.Factory</a>. El m&eacute;todo buildProtocol de la clase Factory  es usado para
crear una instancia Protocol por cada conexi&oacute;n.
</p>

<pre>
    class TimeUUIdFactory(Factory):

        protocol = TimeUUId

        def __init__(self):
            pass

        def buildProtocol(self, addr):
            return TimeUUId()
</pre>

<h4>Iniciando el servidor</h4>

<pre>
    reactor.listenTCP(1320, TimeUUIdFactory())
    reactor.run()
</pre>

<h4>Probando el servidor</h4>

<pre>
    $ telnet 127.0.0.1 1320
    Trying 127.0.0.1...
    Connected to 127.0.0.1.
    Escape character is '^]'.

                      Welcome to Time UUID generator :-)

                      press C to get a time UUID
                      press X to exit
                      c
    ecaa6a3a-35ea-11e3-918a-002185c69ff8
    c
    ee078390-35ea-11e3-9cf9-002185c69ff8
    f
    Invalid option :-( 
    x
    good bye :-) 
    Connection closed by foreign host.
</pre>

<h3>Escribiendo el cliente</h3>

<h4>El protocolo</h4>

<p>La clase que implenta la logica para manejar el parseo y las llamadas es subclase de  
<a href="http://twistedmatrix.com/documents/13.1.0/api/twisted.internet.protocol.Protocol.html">twisted.internet.protocol.Protocol</a>
</p>

<pre>
    from twisted.internet import reactor
    from twisted.internet.protocol import ClientFactory
    from twisted.protocols.basic import LineReceiver

    class TimeUUIdClient(LineReceiver):

        welcome = 'Welcome to Time UUID generator :-)'

        def send_option(self, option):
            self.sendLine(option.replace(' ', ''))

        def ask_option(self):
            print 'press C to get a time UUID or X to exit\n'
            option = raw_input()
            if option.upper() == 'C':
                self.send_option(option.upper())
            elif option.upper() == 'X':
                print 'good bye :-)\n'
                self.transport.loseConnection()
            else:
                print 'invalid option good bye :-(\n'
                self.transport.loseConnection()

        def connectionMade(self):
            self.status = self.option_status['connected']

        def dataReceived(self, line):
            if self.welcome in  line :
                self.ask_option()
            else:
                print line
                self.ask_option()
</pre>

<h4>Factory</h4>

<pre>
    class TimeUUIdClientFactory(ClientFactory):
        def startedConnecting(self, connector):
            print 'Started to connect.'

        def buildProtocol(self, addr):
            print 'Connected.'
            return TimeUUIdClient()

        def clientConnectionLost(self, connector, reason):
            reactor.stop()

        def clientConnectionFailed(self, connector, reason):
            reactor.stop()
</pre>

<h4>Ejecutando el cliente</h4>

<pre>
    # create factory protocol and application
    factory = TimeUUIdClientFactory()

    # connect factory to this host and port
    reactor.connectTCP('localhost', 1320, factory)

    # run client
    reactor.run()
</pre>

<p>
<a href="https://github.com/maigfrga/blog/tree/master/2013/10/intro-twisted/code">El c&oacute;digo fuente puede ser encontrado en este enlace. </a>
</p>
