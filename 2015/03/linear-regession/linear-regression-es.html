<p>
 <a href="https://en.wikipedia.org/wiki/Linear_regression"> 
 Regresi&oacute;n linear </a> es un m&eacute;todo estad&iacute;stico
 utilizado para hacer predicciones, en esto post generaremos una
    regresi&oacute;n lineal sobre informaci&oacute;n 
 <a href="http://estrategiaticolombia.co/estadisticas/opendata/"> del Mintic
 a cerca del crecimiento de Internet en Colombia. </a>

</p>

<h2> Herramientas a usar </h2>

<ul>
    <li>
       <a href=" https://www.python.org/"> Python </a>: Lo usaremos para formatear la informaci&oacute;
    </li>
    <li>
       <a href="https://www.gnu.org/software/octave/"> Octave </a>: Lo usaremos para generar la regresi&oacute;n
    </li>
</ul>

<h2> Formateando los datos </h2>
<p>
    La informaci&oacute;n de MinTic contiene muchas variables sobre 
    diferentes aspectos, necesitamos procesar estos datos para generar
    un archivo cvs donde la primer columna son los meses desde la primera
    medici&oacute;n en Octubre del 2011, la segunda variable es el total
    de afiliados a Internet por periodo. El primer paso es obtener 
    los datos:
</p>

<pre>
    http://estrategiaticolombia.co/estadisticas/opendata/dat_dedicado_general.json
</pre>

<p>
Ahora podemos usar python para generar los datos que vamos a pasar a octave:
</p>

<pre>

from decimal import *


import json
import csv

def total_by_period(jf):
    """
    Process dedicated internet statistics in Colombia from json file downloaded from
    http://estrategiaticolombia.co/estadisticas/opendata/dat_dedicado_general.json
    And generate total  by period
    """
    i = 0
    data_dict = {}

    def proccess_record(line):
        """
        Process every line inside file in order to get a consolidate
        """
        j_line = json.loads(line)[0]
        period_key = '{}-{}'.format(j_line['ANHO'], j_line['PERIODO'])
        j_line['SUSCRIPTORES'] = Decimal(j_line['SUSCRIPTORES'])
        if period_key not in data_dict:
            record = {
                    'total': j_line['SUSCRIPTORES']
            }
            data_dict[period_key]  = record

        else:
            val = j_line['SUSCRIPTORES']
            data_dict[period_key]['total'] += val

    with open(jf, 'r') as f:
        for line in f:
            i +=1

            try:
                proccess_record(line)
            except Exception as e:
                print e
                print 'error processing line {}'.format(i)

            if i > 10000:
                f.close()
                break

    # We must construct an array in format (x, y) where by every period y we have
    # total by period y indexes must be numbers so we get the y axis and
    # create a list of indexes, every item in this list represent a period
    # one period represents 3 months
    period_list = []
    keys = data_dict.keys()
    keys.sort()
    period_index = 0
    with open('total_by_period.csv', 'w') as csvfile:
        spamwriter = csv.writer(csvfile, delimiter=',')
        #every period represents 3 monts
        for n_index in range(len(keys)):
            val = data_dict[keys[n_index]]
            row = (period_index, str(val['total']))
            spamwriter.writerow(row)
            period_index += 3




def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('--task', default='total_by_period')
    parser.add_argument('--file', default='./dat_dedicado_general.json')
    args = parser.parse_args()

    task_dict = {
        'total_by_period': total_by_period,
    }

    task_dict[args.task](args.file)

if __name__ == "__main__":
    main()
</pre>

<h2> Generando la Regresi&oacute;n </h2>

<p>
    Ahora podemos usar octave para generar la regresi&oacute;n, el primer paso
    es cargar los datos y crear dos vectores, uno con los valores de x y 
    otro con los valores de y:
</p>

<pre>
    % Load csv file
    data = load('total_by_period.csv');

    % Define x and y
    x = data(:,1);
    y = data(:,2);
</pre>

<p>
   El siguiente paso es generar la funci&oacute;n para graficar y llamarla:
</p>

<pre>
    % Create a function to plot the data
    function plotData(x,y)
    plot(x,y,'rx','MarkerSize',8); % Plot the data
    end

    % Plot the data

    plotData(x,y);

    ylabel('Internet adoption in Colombia');
    xlabel('Months since october 2011');

    fprintf('Program paused. Press enter to continue.\n');

    pause;
</pre>

<p>
    La funci&oacute;n genera la siguiente imagen:
</p>

<img src="https://raw.githubusercontent.com/maigfrga/blog/master/2015/03/linear-regession/internetadptioncolombia.png" />

<p>
    El siguiente paso es calcular la regresi&oacute;n:
</p>

<pre>
    % Count how many data points we have
    m = length(x); % Add a column of all ones (intercept term) to x
    X = [ones(m, 1) x];

    % Calculate theta

    theta = (pinv(X'*X))*X'*y
</pre>

<p>
    Para nuestros datos de entrada los valores de theta son  [2.1368e+05, 2.3589e+03] esta es nuestgra regresi&oacute;n, ahora podemos dibujarla:
</p>

<pre>
    hold on; % this keeps our previous plot of the training data visible 
    plot(X(:,2), X*theta, '-');
    legend('Training data', 'Linear regression');
    hold off % Do not put any more plots on this figure
    pause;
</pre>


<p>
    A continuaci&oacute;n la imagen resultante:
</p>

<img src="     https://raw.githubusercontent.com/maigfrga/blog/master/2015/03/linear-regession/linear.png  ">

<h2> Tabulando algunos datos </h2>

<p>
Podemos aplicar la  formula <code> y = theta[x] + theta[y] </code>
para obtener algunos datos:

</p>

<pre>
    internet growth = theta[x] * month  + theta[y]
    internet growth = 2.1368e+05 * month + 2.3589e+03
</pre>

<table class="table">
      <thead>
        <tr>
          <th>Meses desde Octubre 2011</th>
          <th>N&uacute;mero de usuarios</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>48 (oct 2015)</td>
          <td> 10258998.9 </td>
        </tr>
        <tr>
          <td>57 (Jun 2016) </td>
          <td>12182118.9 </td>
        </tr>
        <tr>
          <td>72 (oct 2017)</td>
          <td>15387318.9 </td>
        </tr>
      </tbody>
</table>



<h2> Referencias </h2>
<ul>
    <li>
        <a href="https://en.wikipedia.org/wiki/Linear_regression">
            Wikipedia
        </a>
    </li>
    <li>
        <a href="http://www.lauradhamilton.com/tutorial-linear-algebra-with-octave">
        Linear Algebra basis with octave
        </a>
    </li>
    <li>
        <a href="http://www.lauradhamilton.com/tutorial-linear-regression-with-octave">
        An Introduction to Linear Regression Analysis
        </a>
    </li>
    <li>
        <a href="https://gnu.org/software/octave/">
            Octave
        </a>
    </li>
    <li>
        <a href="http://estrategiaticolombia.co/estadisticas/opendata/">
            Open Data Colombia
        </a>
    </li>

</ul>
