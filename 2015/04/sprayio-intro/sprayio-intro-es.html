<div style="width:100%; float:left;">

    <img style="width:30%; float:left;" class="img-thumbnail" src="http://spray.io/img/logo-large.png" />
    <p style="width:69%; float:left; padding:0 2px;">
    <a href="http://spray.io">Spray </a> es un conjunto de librer&iacute;as escritas en Scala que proveen
    soporte para aplicaciones REST/HTTP basadas en 
    <a href="http://www.maigfrga.ntweb.co/akka-toolkit-introduction/"> akka toolkit</a>. En este post crearemos
    un servicio simple con spray.
    </p>
</div>

<h2> Primeros pasos </h2>


<p>
    Spray puede ser ejecutado como un servicio independiente (standalone) o en un contenedor de servlets. Existe
    un
    <a href="https://github.com/spray/spray-template/"> proyecto de ejemplo en  github </a> 
    que puede ser usado como punto inicial. Este repositorio tiene diferentes branches, uno por cada 
    configuraci&oacute;n posible. En este post clonaremos este repositorio y copiaremos la estructura
    existente en el branch <code> on_spray-can_1.3_scala-2.11 </code> el cual contiene un ejemplo
    de aplicaci&oacute;n base standalone spray-can, Scala 2.11 + Akka 2.3 + spray 1.3.
</p>

<pre>
     git clone git@github.com:spray/spray-template.git
     git checkout on_spray-can_1.3_scala-2.11
</pre>



<h3>Ejecutando los test, iniciando y parando la aplicaci&oacute;n </h3>

<p>
    Ejecutando los  tests:
</p>

<pre>
    sbt test
</pre>

<p>
    Para iniciar el servidor debemos ejecutar el comando <code> sbt</code>:
</p>

<pre>
    sbt
    > re-start
    [info] Application demo not yet started
    [info] Starting application demo in the background ...
    demo Starting com.example.Boot.main()
    [success] Total time: 0 s, completed 15-Apr-2015 16:11:08
    > demo [INFO] [04/15/2015 16:11:09.323] [on-spray-can-akka.actor.default-dispatcher-3] [akka://on-spray-can/user/IO-HTTP/listener-0] Bound to localhost/127.0.0.1:8080
</pre>

<p>
    Podemos usar el comando <code> curl </code> para comunicarnos con el servidor:
</p>

<pre>
        $ curl http://localhost:8080
</pre>

<p>
    Deteniendo la aplicaci&oacute;n:
</p>

<pre>
    sbt
    > re-stop

</pre>


<h2> Ejemplo Recurso Rest User </h2>
<p>
    Vamos a implmentar un simple CRUD para un recurso user, solo Crear y consultar por ahora.
</p>


<h3> Serializador Json </h3>

<p>
   Usaremos la librer&iacute;a    <a href="https://github.com/spray/spray-jsonhttps://github.com/spray/spray-json">spray-json </a> para crear la clase  <code>com.notempo1320.ApiJsonProtocol </code> la cual implementar&aacute;
   un protocolo json personalizado:
</p>


<pre>

    package com.notempo1320

    import spray.httpx.SprayJsonSupport._
    import spray.httpx.SprayJsonSupport
    import spray.json._
    import DefaultJsonProtocol._

    case class User(var id: Option[Long], username: String, email: String)

    object ApiJsonProtocol extends DefaultJsonProtocol with SprayJsonSupport {
      //jsonFormatX depends of number of parameters that the object receives
      implicit val userFormat = jsonFormat3(User)

    }
</pre>


<h3>Servicio User</h3>

<p>
    Ahora crearemos una clase hija de la clase  <code> spray.routing.HttpService </code>
    la cual implementar&aacute; la l&oacute;gica http Restful. Esta clase usar&aacute; funcionalidad
    del m&oacute;dulo <a href=""> spray-routing  </a>  el cual implmenta una interfaz para definir
    servicios web Restful.
</p>

<pre>
    // this trait defines our service behavior independently from the service actor
    trait UserService extends HttpService {
      var userList = new ListBuffer[User]()

      val userRoute =
        path("user") {
          get {
            respondWithMediaType(`application/json`) {

              userList.append(User(Option(util.Random.nextInt(10000).toLong), "user1", "email1"))
              userList.append(User(Option(util.Random.nextInt(10000).toLong), "user2", "email2"))
              complete(userList.toList.toJson.compactPrint)
            }
          } ~
          post {
            entity(as[User]) { user =>
              val user2 = User(Option(util.Random.nextInt(10000).toLong), user.username, user.email)
              userList += user2
              respondWithMediaType(`application/json`) {
                complete(StatusCodes.Created, user2.toJson.compactPrint)
              }
            }
          }
        }
    }
</pre>

<p>
    El anterior c&oacute;digo utiliza <a href="http://spray.io/documentation/1.2.3/spray-routing/key-concepts/routes/">routes 
    </a>  para direccionar la petici&oacute;n al componente apropiado.
</p>

<h3> Actor User  </h3>

<p>
    Crearemos ahora un actor que usar&aacute; la l&oacute;gica implementada en el servicio:
</p>


<pre>
    // we don't implement our route structure directly in the service actor because
    // we want to be able to test it independently, without having to spin up an actor
    class UserActor extends Actor with UserService {

      // the HttpService trait defines only one abstract member, which
      // connects the services environment to the enclosing actor or test
      def actorRefFactory = context

      // this actor only runs our route, but you could add
      // other things here, like request stream processing
      // or timeout handling
      def receive = runRoute(userRoute)
    }
</pre>

<h3> Clase Api  </h3>

<p>
    La clase api es un comando de consola encargado de iniicar el servidor
    <a href="http://spray.io/documentation/1.2.3/spray-can/" > spray-can  </a>:

</p>

<pre>
    package com.notempo1320

    import akka.actor.{ActorSystem, Props}
    import akka.io.IO
    import spray.can.Http
    import akka.pattern.ask
    import akka.util.Timeout
    import scala.concurrent.duration._

    object Api extends App {

      // we need an ActorSystem to host our application in
      implicit val system = ActorSystem("on-spray-can")

      // create and start our service actor
      val service = system.actorOf(Props[UserActor], "user-service")

      implicit val timeout = Timeout(5.seconds)
      // start a new HTTP server on port 8080 with our service actor as the handler
      IO(Http) ? Http.Bind(service, interface = "localhost", port = 7000)
    }
</pre>


<h3> Actualizando archivo de configuraci&oacute;n build.sbt</h3>

<pre>

    organization  := "com.notempo1320"

    version       := "0.1"

    scalaVersion  := "2.11.6"

    scalacOptions := Seq("-unchecked", "-deprecation", "-encoding", "utf8")

    libraryDependencies ++= {
      val akkaV = "2.3.9"
      val sprayV = "1.3.3"
      Seq(
        "io.spray"            %%  "spray-can"     % sprayV,
        "io.spray"            %%  "spray-routing" % sprayV,
        "io.spray"            %%  "spray-json"    % "1.3.1",
        "io.spray"            %%  "spray-httpx"   % sprayV,
        "io.spray"            %%  "spray-testkit" % sprayV  % "test",
        "com.typesafe.akka"   %%  "akka-actor"    % akkaV,

        "com.typesafe.akka"   %%  "akka-testkit"  % akkaV   % "test",
        "org.specs2"          %%  "specs2-core"   % "2.3.11" % "test"
      )
    }



    Revolver.settings
    mainClass in (Compile, run) := Some("com.notempo1320.Api")
    mainClass in Revolver.reStart := Some("com.notempo1320.Api")
</pre>

<h3> Creando un usuario</h3>

<pre>
    curl -i -H "Accept: application/json" -H "Content-Type: application/json" -X POST -d '{"username": "myname", "email": "mymail@server.com"}' http://localhost:7000/user
</pre>

<h3> Obteniendo una lista de usuarios</h3>

<pre>
  curl http://localhost:7000/user
</pre>

<p>
El c&oacute;digo fuente de este ejemplo  <a href="https://github.com/maigfrga/blog/tree/master/2015/04/sprayio-intro/demo"> se encuentra en este enlace </a>

</p>
<h2> Referencias </h2>


<ul>
    <li>
       <a href="http://spray.io/introduction/what-is-spray/"> What is spray </a>
    </li>
    <li>
        <a href="http://doc.akka.io/docs/akka-stream-and-http-experimental/1.0-M2/scala/http/path-matchers.html"> Akka Path matchers</a>
    </li>
    <li>
        <a href="https://github.com/spray/spray-template/"> Github spray template</a>
    </li>
    <li>
         <a href="https://github.com/karthik20522/SprayLearning"> Github karthik20522/SprayLearning </a>
    </li>
    <li>
       <a href="https://github.com/oermolaev/simple-scala-rest-example">simple-scala-rest-example</a>
    </li>
    <li>
        <a href="http://www.maigfrga.ntweb.co/akka-toolkit-introduction/">Introduction to akka toolkit </a>
    </li>
</ul>
