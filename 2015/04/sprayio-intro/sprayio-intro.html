<p>
    <a href="http://spray.io">Spray </a> is a suite of lightweight Scala libraries providing client and server-side REST/HTTP support on top Akka. It provides a set of integrated components for most of REST/HTTP needs.
    In this post we are going to create a simple restful API with spray.
</p>


<h2> Getting Started </h2>




<p>
    Spray can run as an standalone service or inside a servlet container. There is a 
    <a href="https://github.com/spray/spray-template/"> spray template project on github </a> that can be used as starting point. This github repository has  different branches, one branch for every possible
    configuration, we will clone this repo and we will use the branch  <code> on_spray-can_1.3_scala-2.11 </code>. This branch contains the structure for a standalone spray-can, Scala 2.11 + Akka 2.3 + spray 1.3
</p>


<pre>
     git clone git@github.com:spray/spray-template.git
     git checkout on_spray-can_1.3_scala-2.11
</pre>



<h3>Running tests, Starting and stopping applicaton </h3>

<p>
    Running tests:
</p>

<pre>
    sbt test
</pre>

<p>
    To run server you need to execute <code> sbt</code>:
</p>

<pre>
    sbt
    > re-start
    [info] Application demo not yet started
    [info] Starting application demo in the background ...
    demo Starting com.example.Boot.main()
    [success] Total time: 0 s, completed 15-Apr-2015 16:11:08
    > demo [INFO] [04/15/2015 16:11:09.323] [on-spray-can-akka.actor.default-dispatcher-3] [akka://on-spray-can/user/IO-HTTP/listener-0] Bound to localhost/127.0.0.1:8080
</pre>

<p>
    You can now request the applicaton using <code> curl </code> command:
</p>

<pre>
        $ curl http://localhost:8080
</pre>

<p>
    Stopping application:
</p>

<pre>
    sbt
    > re-stop

</pre>


<h2> User Resource Example </h2>
<p>
    We are going to implement a basic CRUD for a user resource. Just Crate and Get for now.
</p>


<h3> Json serializer</h3>

<p>
  In order   to handle json serialization,  we will use 
        <a href="https://github.com/spray/spray-jsonhttps://github.com/spray/spray-json">spray-json </a> to
        create the class <code>com.notempo1320.ApiJsonProtocol </code> that will implement
        a custom json protocol:
</p>

<pre>

    package com.notempo1320

    import spray.httpx.SprayJsonSupport._
    import spray.httpx.SprayJsonSupport
    import spray.json._
    import DefaultJsonProtocol._

    case class User(var id: Option[Long], username: String, email: String)

    object ApiJsonProtocol extends DefaultJsonProtocol with SprayJsonSupport {
      //jsonFormatX depends of number of parameters that the object receives
      implicit val userFormat = jsonFormat3(User)

    }
</pre>


<h3> User Service</h3>

<p>
    We are going to create a class child of spray.routing.HttpService that will implement the Restful http
    logic. This class uses functionality from <a href=""> spray-routing  </a> module, this module
    provides a high-level routing DSL for defining RESTful web services.
</p>


<pre>
    // this trait defines our service behavior independently from the service actor
    trait UserService extends HttpService {
      var userList = new ListBuffer[User]()

      val userRoute =
        path("user") {
          get {
            respondWithMediaType(`application/json`) {

              userList.append(User(Option(util.Random.nextInt(10000).toLong), "user1", "email1"))
              userList.append(User(Option(util.Random.nextInt(10000).toLong), "user2", "email2"))
              complete(userList.toList.toJson.compactPrint)
            }
          } ~
          post {
            entity(as[User]) { user =>
              val user2 = User(Option(util.Random.nextInt(10000).toLong), user.username, user.email)
              userList += user2
              respondWithMediaType(`application/json`) {
                complete(StatusCodes.Created, user2.toJson.compactPrint)
              }
            }
          }
        }
    }
</pre>

<p>
    The code above use <a href="http://spray.io/documentation/1.2.3/spray-routing/key-concepts/routes/">routes </a>  to deliver the request to the appriate component.
</p>


<h3> UserActor </h3>

<p>
    Next step is to creat an Actor that will wrap UserService logic:
</p>


<pre>
    // we don't implement our route structure directly in the service actor because
    // we want to be able to test it independently, without having to spin up an actor
    class UserActor extends Actor with UserService {

      // the HttpService trait defines only one abstract member, which
      // connects the services environment to the enclosing actor or test
      def actorRefFactory = context

      // this actor only runs our route, but you could add
      // other things here, like request stream processing
      // or timeout handling
      def receive = runRoute(userRoute)
    }
</pre>


<h3> Api class </h3>

<p>
    We need to create a console command wich will be responsible to run 
    <a href="http://spray.io/documentation/1.2.3/spray-can/" > spray-can  </a> server:

</p>

<pre>
    package com.notempo1320

    import akka.actor.{ActorSystem, Props}
    import akka.io.IO
    import spray.can.Http
    import akka.pattern.ask
    import akka.util.Timeout
    import scala.concurrent.duration._

    object Api extends App {

      // we need an ActorSystem to host our application in
      implicit val system = ActorSystem("on-spray-can")

      // create and start our service actor
      val service = system.actorOf(Props[UserActor], "user-service")

      implicit val timeout = Timeout(5.seconds)
      // start a new HTTP server on port 8080 with our service actor as the handler
      IO(Http) ? Http.Bind(service, interface = "localhost", port = 7000)
    }
</pre>


<h3> Updating build.sbt</h3>

<pre>

    organization  := "com.notempo1320"

    version       := "0.1"

    scalaVersion  := "2.11.6"

    scalacOptions := Seq("-unchecked", "-deprecation", "-encoding", "utf8")

    libraryDependencies ++= {
      val akkaV = "2.3.9"
      val sprayV = "1.3.3"
      Seq(
        "io.spray"            %%  "spray-can"     % sprayV,
        "io.spray"            %%  "spray-routing" % sprayV,
        "io.spray"            %%  "spray-json"    % "1.3.1",
        "io.spray"            %%  "spray-httpx"   % sprayV,
        "io.spray"            %%  "spray-testkit" % sprayV  % "test",
        "com.typesafe.akka"   %%  "akka-actor"    % akkaV,

        "com.typesafe.akka"   %%  "akka-testkit"  % akkaV   % "test",
        "org.specs2"          %%  "specs2-core"   % "2.3.11" % "test"
      )
    }



    Revolver.settings
    mainClass in (Compile, run) := Some("com.notempo1320.Api")
    mainClass in Revolver.reStart := Some("com.notempo1320.Api")
</pre>

<h3> Creating an user</h3>

<pre>
    curl -i -H "Accept: application/json" -H "Content-Type: application/json" -X POST -d '{"username": "myname", "email": "mymail@server.com"}' http://localhost:7000/user
</pre>

<h3> Getting a list of users</h3>

<pre>
  curl http://localhost:7000/user
</pre>



<h2> References </h2>


<ul>
    <li>
       <a href="http://spray.io/introduction/what-is-spray/"> What is spray </a>
    </li>
    <li>
        <a href="http://doc.akka.io/docs/akka-stream-and-http-experimental/1.0-M2/scala/http/path-matchers.html"> Akka Path matchers</a>
    </li>
    <li>
        <a href="https://github.com/spray/spray-template/"> Github spray template</a>
    </li>
    <li>
         <a href="https://github.com/karthik20522/SprayLearning"> Github karthik20522/SprayLearning </a>
    </li>
    <li>
       <a href="https://github.com/oermolaev/simple-scala-rest-example">simple-scala-rest-example</a>
    </li>
</ul>
