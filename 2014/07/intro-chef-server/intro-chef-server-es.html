<p>Chef es un sistema y framework de automatizaci&oacute;n que permite el despliegue de servidores y aplicaciones en cualquier ubicaci&oacute;n f&iacute;sica, 
virtual, o en la nube. Esta gu&iacute;a es una introducci&oacute;n  a los principales coneceptos de chef.
 <a href="http://docs.opscode.com/">En este  enlace se puede encontrar la documentaci&oacute;n oficial</a>
</p>

<h2>Componentes Chef  </h2>

<h3>Nodos</h3>

<p>
  Un nodo es una m&aacute;quina f&iacute;sica, virtual o en la nube que es configurada y mantenida por chef-client.
</p>

<h3>Workstations</h3>

<p>
    Una estaci&oacute;n de trabajo  workstation es  un computador configurado para ejecutar  Knife, para sincronizar el repositorio chef e interactuar con un 
    servidor chef.
    Tareas t&iacute;picas desarrolladas en una workstation son :
</p>

<ul>
    <li>
      Desarrollar cookbooks y recipes.
    </li>
    <li>
      Mantener el repositorio chef sincronizado bajo un control de versiones.
    </li>
    <li>
      Usar Knife para subir objetos desde el  chef-repo a el Chef server.
    </li>
    <li>
      Configurar pol&iacute;ticas organizacionales, asegurandose que informaci&oacute;n sensible es almacenada en data bags .
    </li>
    <li>
      Interactuar con nodos.
    </li>
</ul>

<h3>Knife </h3>
<p>
  Knife es una herramienta de l&iacute;nea de comandos que provee una interfaz entre un repositorio chef local y un chef-server. Knife ayuda a los 
  usuarios a gestionar:
</p>

<ul>
    <li>Nodos.</li>
    <li>Cookbooks y recipes.</li>
    <li>Roles.</li>
    <li> JSON data (data bags), incluida informaci&oacute;n encriptada .</li>
    <li>Entornos.</li>
    <li>Recursos en la nube, incluido su provsionamiento.</li>
    <li>Instalac&iacute;on de el clliente chef en workstations.</li>
    <li>Buscar informaci&oacute;n indexada en Chef server.</li>
</ul>

<h3>Repositorio</h3>
<p>
     chef-repo es la ubicaci&oacute;n donde los siguientes objetos son almacenados:
</p>

<ul>
  <li>Cookbooks (incluidos recipes, versions, cookbook attributes, resources, providers, libraries, and templates).</li>
  <li>Roles.</li>
  <li>Data bags.</li>
  <li>Entornos.</li>
  <li>Archivos de configuraci&oacute;n.</li>
</ul>

<h3>Hosted Server</h3>

<p>
  El servidor chef almacena cookbooks(recetas), las pol&iacute;ticas que son aplicadas a los nodos y la metadata que describe cada nodo registrado
  y como es mantenido por chef-client.
  Los Nodos usan chef-client para preguntar al  Chef server detgalles de configuraci&oacute;n , como recetas, plantillas, etc.
  Los clientes chef hace todo el trabajo posible de configuraci&oacute;n en los  nodos y no en el chef server.
</p>

<h3>Cookbooks</h3>
<p>
Cookbook es la unidad fundamental de configuraci&oacute;n y distribuci&oacute;n. Cada cookbook define un escenario y contiene los componentes requeridos
para soportar este escenario, incluyendo:
</p>

<ul>
  <li>Attributos que ser&aacute;n asignados a nodos.</li>
  <li>Definiciones que permiten la creaci&oacute;n de recursos reusables.</li>
  <li>Distribuci&oacute;n de archivos.</li>
  <li>Librerias que extienden  chef-client .</li>
</ul>

<H2>Ejemplo Chef</H2>

<p>
   En este ejemplo usaremos Linux Centos 6.5 como chef server. Configuraremos un ubuntu server como workstation  e instalaremos un compilador de c en otro ubuntu.
</p>

<h3>Configuraci&oaucte;n de red</h3>

<table class="table">
    <thead>
        <tr>
            <th>Hostname</th>
            <th>ip</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>chef-server</td>
            <td>10.0.0.10</td>
        </tr>
        <tr>
            <td>station1</td>
            <td>10.0.0.20</td>
        </tr>
        <tr>
            <td>db-node</td>
            <td>10.0.0.30</td>
        </tr>
    </tbody>
</table>

<h3>Instalar Chef Server</h3>
<p>
 Ir a <a href="http://www.getchef.com/chef/install/">http://www.getchef.com/chef/install/ </a>. Seleccionar plataforma y versi&oacute;n . Descargar
 el archivo e instarlo .
</p>

<pre>
  $wget    https://opscode-omnibus-packages.s3.amazonaws.com/el/6/x86_64/chef-server-11.1.3-1.el6.x86_64.rpm
  $sudo rpm -Uvh chef-server-11.1.3-1.el6.x86_64.rpm
</pre>

<p>Configurar chef-server</p>

<pre>
 $sudo chef-server-ctl reconfigure
</pre>

<h3>Instalar Chef workstation </h3>
<p>
 Ir a <a href="http://www.getchef.com/chef/install/">http://www.getchef.com/chef/install/ </a>. Seleccinar download chef-client, seleccionar plataforma
 y versi&oacute; seguir las instrucciones.
</p>

<pre>
  $curl -L https://www.opscode.com/chef/install.sh | sudo bash  
</pre>

<p>
    Verificar instalaci&oacute;n:
</p>

<pre>
    $chef-client -v
    
</pre>

<h4>Configurar chef Repo</h4>
<h5> Instalar git</h5>

<pre>
    $sudo apt-get install git
</pre>

<h5> Clonar chef Repo</h5>
<pre>
  $git clone git://github.com/opscode/chef-repo.git  
</pre>

<h5> Crear .chef Directorio </h5>

<p>
 El directorio .chef  es usado para almacenar 3 arvhivos:  <strong>knife.rb</strong>, <strong>ORGANIZATION-validator.pem</strong> and <strong>USER.pem</strong>.

</p>
<p>
ORGANIZATION y USER representan cadenas que son &uacute;nicas a cada organizaci&oacute;n. Estos archivos deben estar presentes en el directorio  .chef 
para que la workstation se pueda conectar a Chef server. <br>
Para crear el directorio .chef:
</p>

<pre>
  $sudo mkdir -p ~/chef-repo/.chef  
</pre>

<p>
Agregar .chef al arvhivo .gitignore para evitar publicaci&oacute;n de informaci&oacute;n sensible :
</p>
<pre>
 $echo '.chef' >> ~/chef-repo/.gitignore
</pre>

<h5>Obtener los arvhivos de configuraci&oacute;n</h5>

<p>
    Copiar los archivos  /etc/chef-server/chef-validator.pem /etc/chef-server/admin.pem desde chef-server a station1 en una ubicaci&oacute;n segura 
    y ejecutar el comando
    <code>knife configure --initial </code>. este comando preguntara por la ubicaci&oacute;n del archivo chef-validator.pem .
</p>

<pre>
    $ knife configure --initial
    Overwrite /home/manuel/.chef/knife.rb? (Y/N)y
    Please enter the chef server URL: [https://station1:443] https://chef-server:443
    Please enter a name for the new user: [manuel] 
    Please enter the existing admin name: [admin] 
    Please enter the location of the existing admin's private key: [/etc/chef-server/admin.pem] 
    Please enter the validation clientname: [chef-validator] 
    Please enter the location of the validation key: [/etc/chef-server/chef-validator.pem] 
    Please enter the path to a chef repository (or leave blank): 
    Creating initial API user...
    Please enter a password for the new user: 
    Created user[manuel]
    Configuration file written to /home/manuel/.chef/knife.rb
    
</pre>

<h5>Agregar Ruby a la variable $PATH </h5>

<pre>
    $echo 'export PATH="/opt/chef/embedded/bin:$PATH"' >> ~/.bash_profile && source ~/.bash_profile
    
</pre>

<h5>Verificar la instalaci&oacute;n de  chef-client</h5>

<pre>
    cd ~/chef-repo
    knife client list
    
</pre>

<h3>  Inicializar un Nodo </h3>

<p>
    Existen dos formas de inicializar un nodo:
</p>

<ul>
    <li>Usar el comando knife con la opcion bootstrap.</li>
    <li>Usar un instalador automatico.</li>
</ul>

<p>
    <strong> Este post cubre la opci&oacute;n del comando knife</strong>
</p>


<p>In este post configuraremos un unbuntu server e instalaremos un compilador de c.  </p>

<h4> Ejecutar el comando bootstrap</h4>
<p>
El comando knife bootstrap es usado para conectare en forma remota al nodo, instalar el chef-client, generar keys y registrar el nodo en el chef server. 
Para configurar el nodo ejecutar el siguiente comando:
</p>

<pre>
    $ knife bootstrap db-node -x username -P password --sudo
</pre>


<p>Verificar instalaci&oacute;n:
</p>

<pre>
    $knife client show db-node
</pre>

<h3>Opscode C compilere Cookbook </h3>

<p>
    <a href="https://github.com/opscode-cookbooks/build-essential"> Opscode Build Essential </a> es un repositorio en  github repository creado por 
    el equipo de opscode que provee funcionalidad para instalar un compilador de c, el primer paso es clonar el cookbook en la workstation:
</p>

<pre>
    $mkdir ~/cookbooks
    $cd ~/cookbooks
    $git clone https://github.com/opscode-cookbooks/apt.git
    $git clone https://github.com/opscode-cookbooks/build-essential.git
    $git clone https://github.com/opscode-cookbooks/openssl.git
    $git clone https://github.com/sethvargo/chef-sugar.git
</pre>

<p>
    editar .chef/knife.rb y agreagar una nueva ubicaci&oacute;n para los cookbooks:
</p>

<pre>
  cookbook_path  ['/home/manuel/chef-repo/cookbooks/', '/home/manuel/cookbooks']
</pre>

<p>Subir los cookbooks a chef-server:
</p>

<pre>
    $knife cookbook upload apt
    $knife cookbook upload build-essential
    $knife cookbook upload chef-sugar
    $knife cookbook upload openssl
</pre>

<h4>Agregar la receta al run_list del nodo </h4>

<p>Agreagaremos la receta  build-essential al run_list del nodo:
</p>

<pre>
    $knife node run_list add  db-node  recipe[build-essential::default]
    db-node:
      run_list: recipe[build-essential::default]

    $knife node show db-node

</pre>

<p>Antes de instlar el compilador verificamos que el servidor no tenga un compilador instalado:
</p>

<pre>
    $ gcc
    The program 'gcc' is currently not installed. You can install it by typing:
    sudo apt-get install gcc
</pre>

<p>
Ejecutar el comando chef-client desde el nodo ejecutara las recetas configuradas en el run_list:
</p>

<pre>
    $sudo chef-client
</pre>



<p>Al finaliza la ejecuci&oacute; podemos verficiar que le compilador ha sido instalado:</p>

<pre>
    $gcc -v
    Using built-in specs.
    COLLECT_GCC=gcc
    COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/4.8/lto-wrapper
    Target: x86_64-linux-gnu
    Configured with: ../src/configure -v --with-pkgversion='Ubuntu 4.8.2-19ubuntu1' --with-bugurl=file:///usr/share/doc/gcc-4.8/README.Bugs --enable-languages=c,c++,java,go,d,fortran,objc,obj-c++ --prefix=/usr --program-suffix=-4.8 --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --with-gxx-include-dir=/usr/include/c++/4.8 --libdir=/usr/lib --enable-nls --with-sysroot=/ --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --enable-gnu-unique-object --disable-libmudflap --enable-plugin --with-system-zlib --disable-browser-plugin --enable-java-awt=gtk --enable-gtk-cairo --with-java-home=/usr/lib/jvm/java-1.5.0-gcj-4.8-amd64/jre --enable-java-home --with-jvm-root-dir=/usr/lib/jvm/java-1.5.0-gcj-4.8-amd64 --with-jvm-jar-dir=/usr/lib/jvm-exports/java-1.5.0-gcj-4.8-amd64 --with-arch-directory=amd64 --with-ecj-jar=/usr/share/java/eclipse-ecj.jar --enable-objc-gc --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --with-tune=generic --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu
    Thread model: posix
    gcc version 4.8.2 (Ubuntu 4.8.2-19ubuntu1)
</pre>
