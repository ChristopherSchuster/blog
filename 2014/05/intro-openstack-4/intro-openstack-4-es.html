Introduccion OpenStack para Ubuntu Parte IV


<p> Esta es la cuarta parte de la serie de Introducci&oacute;n a Open Stack. 
<a href="http://www.maigfrga.ntweb.co/openstack-introduction-ubuntu-part-i/">La primera parte habla sobre conceptos generales,
configuraciones b&aacute;sicas e instalaci&oacute;n the servicio de autenticaci&oacute;n </a>, 
<a href="http://www.maigfrga.ntweb.co/openstack-introduction-ubuntu-part-ii/"> la segunda parte habla sobre los servicios
 de gestion de imagenes y maquinas virtuales.</a>, 
 <a href="http://www.maigfrga.ntweb.co/introduccion-a-openstack-para-ubuntu-parte-iii/"> la tercer parte habla sobre el panel de control
 y  block storage.</a>. Esta parte habla sobre el servicio de almacenamiento (Object Storage)
<a href="http://docs.openstack.org/havana/install-guide/install/apt/content/">En este enlace se puede encontrar la documentaci&oacute;n oficial.</a>
</p>


<h3>Instalando Object Storage</h3>

<h4>Object Storage service</h4>

<p>
Este servicio es un sistema de alcenamiento de grandes cantidades de datos no estructurados que pueden ser accedidos utilizando una API RESTful HTTP .
Incluye los siguientes componentes:
</p>

<ul>
    <li>Proxy servers (swift-proxy-server). Acepta peticiones HTTP para gestionar archivos y contenedores.</li>
    <li>Account servers (swift-account-server). Gestiona cuentas definidas por el  Object Storage service  </li>
    <li>Container servers (swift-container-server). Administra el mapeo de contenedores o folders.</li>
    <li>Object servers (swift-object-server). Gestiona los archivos en los nodos.  </li>
    <li>Procesos periodicos de mantenimiento  (auditors, updaters, reapers) </li>
</ul>

<h4> Requirementos del sistema</h4>
<p>Para efectos ilustrativos de esta gu&iacute;a no hablaremos de este tema , para un entorno real de producci&oacute; <a href="http://docs.openstack.org/havana/install-guide/install/apt/content/object-storage-system-requirements.html"> Es necesario analizar detalladamente los requerimientos definidos en este 
enlace. </a> 
</p>

<h4>Planeando la configuraci&oacute;n de red</h4>

<p>
En esta gu&iacute;a configuraremos una red interna de un servidor proxy y 3 nodos de almacenamiento


</p>
 
<pre>
    192.168.0.13    swift-proxy
    192.168.0.14    storage1
    192.168.0.15    storage2
    192.168.0.16    storage3
</pre>

<p>
    El parametro  STORAGE_LOCAL_NET_IP is la direcci&oacute;n IP de cada nodo de almacenamiento.
</p>

<p>
<a href="http://docs.openstack.org/havana/install-guide/install/apt/content/object-storage-network-planning.html"> 
Otras opciones de configuraciones de red en este enlace</a>
</p>



<h4>Ejemplo de arquitectura de Object Storage </h4>

<ul>
    <li>
        Node: Un host que ejecuta uno o m&aacute;s servicios  OpenStack Object Storage.
    </li>

    <li>
        Proxy node:  Ejecuta servicios proxy.
    </li>

    <li>
        Storage node: Ejecuta servicios de cuentas, contenedores y objetos.
    </li>    

    <li>
        Ring:  Un conjunto de mapeos entre datos del servicio OpenStack Object Storage data y dispositivos f&iacute;sicos.
    </li>

    <li>
    Replica: Una copia de un objecto, por defecto 3 copias de cada objeto son almacenadas en el cluster .
    </li>

    <li>
    Zona:  Una secci&oacute;n logicamente separada del cluster.
    </li>
</ul>   

<p><strong>Nota:</strong> En esta  gu&iacute;a instalaremos un proxy node el cual ejecuta los procesos swift-proxy-server y 3
    storage nodes  que ejecutan los procesos swift-account-server, swift-container-server y swift-object-server </p>

<p> Editar el archivo  /etc/hosts en todos los nodos de Open stack (controller, block1 , storage1...)

</p>

<pre>
    127.0.0.1       localhost
    192.168.0.10    controller
    192.168.0.11    compute1
    192.168.0.12    block1
    192.168.0.13    swift-proxy
    192.168.0.14    storage1
    192.168.0.15    storage2
    192.168.0.16    storage3
</pre>

<p>Editar /etc/hostname y definir hostname en swift-proxy, storage1, storage2, storage3
</p>

<h4>Pasos generales de instalci&oacute;n</h4>
<p> Agregar repositorios de Open Stack</p>

<pre>
   # apt-get install python-software-properties
   # add-apt-repository cloud-archive:havana 
   # apt-get update && apt-get dist-upgrade
   # reboot
</pre>

<p>
Crear un usuario swift que el Object Storage Service utilizar&aacute; para autenticarse en  Identity Service.
Ejecutar los siguientes comandos en el nodo controller:
</p>

<pre>
   # keystone user-create --name=swift --pass=SWIFT_PASS \
  --email=swift@example.com
  # keystone user-role-add --user=swift --tenant=service --role=admin 

    +----------+----------------------------------+
    | Property |              Value               |
    +----------+----------------------------------+
    |  email   |        swift@example.com         |
    | enabled  |               True               |
    |    id    | b64f304b7dad485ea960dfa0296bb63d |
    |   name   |              swift               |
    +----------+----------------------------------+

</pre>

<p>
    Crear una entrada de servico para el Object Storage Service: 
</p>

<pre>
   # keystone service-create --name=swift --type=object-store \
  --description="Object Storage Service" 

    +-------------+----------------------------------+
    |   Property  |              Value               |
    +-------------+----------------------------------+
    | description |      Object Storage Service      |
    |      id     | e54246ea9eb64d5ca002cbf5481dd5eb |
    |     name    |              swift               |
    |     type    |           object-store           |
    +-------------+----------------------------------+

</pre>

<p>
Definir un API endpoint para el Object Storage Service usando el id retornado en el comando anterior. 
</p>

<pre>
# keystone endpoint-create \
  --service-id=the_service_id_above \
  --publicurl='http://swift-proxy:8080/v1/AUTH_%(tenant_id)s' \
  --internalurl='http://swift-proxy:8080/v1/AUTH_%(tenant_id)s' \
  --adminurl=http://swift-proxy:8080

    +-------------+----------------------------------------------+
    |   Property  |                    Value                     |
    +-------------+----------------------------------------------+
    |   adminurl  |            http://controller:8080            |
    |      id     |       e8f5a0654b7f4af6a9c2357250dd5c63       |
    | internalurl | http://controller:8080/v1/AUTH_%(tenant_id)s |
    |  publicurl  | http://controller:8080/v1/AUTH_%(tenant_id)s |
    |    region   |                  regionOne                   |
    |  service_id |       e54246ea9eb64d5ca002cbf5481dd5eb       |
    +-------------+----------------------------------------------+

</pre>

<p>
    Crear archivo de configuraci&oacute;n en todos los nodos swift:
</p>

<pre>
   # mkdir -p /etc/swift 
</pre>

<p>
Crear /etc/swift/swift.conf en todos los nodos:
</p>

<pre>
    [swift-hash]
    # random unique string that can never change (DO NOT LOSE)
    swift_hash_path_suffix = afLIeftgibit
</pre>

<p>
    <strong>Nota:</strong> El sufijo en /etc/swift/swift.conf debe ser una cadena aleatoria
    que sera usada como  salt al construir el  hash  para determinar los mapeos en el anillo. Este valor debe ser igual en todos los nodos del cluster 
</p>

<h4>Instalar y configurar Storage nodes</h4>

<p>Instalar paquetes Storage node:</p>

<pre>
   # apt-get install swift swift-account swift-container swift-object xfsprogs 
</pre>

<p>
Para cada dispositivo que se quiera usar para almacenamiento, definir volumen XFS  (/dev/sdb es usado como ejemplo). Usar una sola partici&oacute;n por
disco.
</p>

<pre>
    # fdisk /dev/sdb
    # mkfs.xfs /dev/sdb1
    # echo "/dev/sdb1 /srv/node/sdb1 xfs noatime,nodiratime,nobarrier,logbufs=8 0 0" >> /etc/fstab
    # mkdir -p /srv/node/sdb1
    # mount /srv/node/sdb1
    # chown -R swift:swift /srv/node
</pre>


<p>
    Crear /etc/rsyncd.conf:
</p>

<pre>
    uid = swift
    gid = swift
    log file = /var/log/rsyncd.log
    pid file = /var/run/rsyncd.pid
    address = STORAGE_LOCAL_NET_IP
     
    [account]
    max connections = 2
    path = /srv/node/
    read only = false
    lock file = /var/lock/account.lock
     
    [container]
    max connections = 2
    path = /srv/node/
    read only = false
    lock file = /var/lock/container.lock
     
    [object]
    max connections = 2
    path = /srv/node/
    read only = false
    lock file = /var/lock/object.lock
</pre>

<p>
    Editar la siguiente l&iacute;nea en /etc/default/rsync:
</p>

<pre>
    RSYNC_ENABLE=true
</pre>

<p>
Iniciar el servicio rsync:
</p>

<pre>
   # service rsync start 
   # mkdir -p /var/swift/recon
  # chown -R swift:swift /var/swift/recon

</pre>

<h4>Instalar and configurar proxy node</h4>

<p>
  El proxy server toma cada petici&oacute;n y la redirecciona al servicio apropiado  (account, container,object) . 
  El proxy server igualmente gestiona las peticiones API. El servicio se habilita y configura en  el archivo /etc/swift/proxy-server.conf. 
</p>

<p>Instalar servicio swift-proxy:</p>

<pre>
   # apt-get install swift-proxy memcached python-keystoneclient python-swiftclient python-webob 
</pre>

<p>
Modificar memcached para escuchar en la red local privada. Editar esta l&iacute;nea en el archivo  /etc/memcached.conf : 
cambiar 
</p>

<pre>
   -l 127.0.0.1 
</pre>

<p> por:</p>

<pre>
   -l PROXY_LOCAL_NET_IP 
</pre>

<p>Reiniciar el servicio memcached:</p>

<pre>
   # service memcached restart 
</pre>

<p>
Crear /etc/swift/proxy-server.conf:
</p>

<pre>
   [DEFAULT]
    bind_port = 8080
    user = swift
     
    [pipeline:main]
    pipeline = healthcheck cache authtoken keystoneauth proxy-server
     
    [app:proxy-server]
    use = egg:swift#proxy
    allow_account_management = true
    account_autocreate = true
     
    [filter:keystoneauth]
    use = egg:swift#keystoneauth
    operator_roles = Member,admin,swiftoperator
     
    [filter:authtoken]
    paste.filter_factory = keystoneclient.middleware.auth_token:filter_factory
     
    # Delaying the auth decision is required to support token-less
    # usage for anonymous referrers ('.r:*').
    delay_auth_decision = true
     
    # cache directory for signing certificate
    signing_dir = /home/swift/keystone-signing
     
    # auth_* settings refer to the Keystone server
    auth_protocol = http
    auth_host = controller
    auth_port = 35357
     
    # the service tenant and swift username and password created in Keystone
    admin_tenant_name = service
    admin_user = swift
    admin_password = SWIFT_PASS
     
    [filter:cache]
    use = egg:swift#memcache
    memcache_servers = PROXY_LOCAL_NET_IP

    [filter:catch_errors]
    use = egg:swift#catch_errors
     
    [filter:healthcheck]
    use = egg:swift#healthcheck 
</pre>


<p>
   Crear los anillos account, container y object. The comando builder crea un archivo builder con unos cuantos parametros.
 
</p>

<pre>
    # cd /etc/swift
    # swift-ring-builder account.builder create 18 3 1
    # swift-ring-builder container.builder create 18 3 1
    # swift-ring-builder object.builder create 18 3 1 
</pre>

<p>

El parametro con el valor 18 representa  2 ^ 18t y es el valor del tama&ntilde;o the la particion.
Este valor debe ser definido teniendo en cuenta el monto total de almacenamiento que se espera usar
en el anillo. El valor 3 representa el n&uacute;mero de replicas de cada objeto, el ultimo valor representa
el n&uacute;mero de horas restringidas antes de mover una partici&oacute;n m&aacute; de una vez.
</p>

<p>
Para cada dispositvio de almacenamiento en cada nodo agregar a cada anillo:
</p>

<pre>
    # swift-ring-builder account.builder add zZONE-STORAGE_LOCAL_NET_IP:6002[RSTORAGE_REPLICATION_NET_IP:6005]/DEVICE 100
    # swift-ring-builder container.builder add zZONE-STORAGE_LOCAL_NET_IP_1:6001[RSTORAGE_REPLICATION_NET_IP:6004]/DEVICE 100
    # swift-ring-builder object.builder add zZONE-STORAGE_LOCAL_NET_IP_1:6000[RSTORAGE_REPLICATION_NET_IP:6003]/DEVICE 100
</pre>



<p>
 En esta gu&iacute;a, cada nodo de almacenamiento tiene una particion en la zona 1, sus direcciones IP
 son 192.168.0.14, 192.168.0.15 and 192.168.0.16 sin red de replicaci&oacute;n. 
 El punto de montaje de cada partici&oacute;n es /srv/node/sdb1, y la ruta en 
 /etc/rsyncd.conf es /srv/node/, the DEVICE would be sdb1 and the commands are: 
</p>

<pre>

    # swift-ring-builder account.builder add z1-192.168.0.14:6002/sdb1 100
    # swift-ring-builder container.builder add z1-192.168.0.14:6001/sdb1 100
    # swift-ring-builder object.builder add z1-192.168.0.14:6000/sdb1 100

    # swift-ring-builder account.builder add z1-192.168.0.15:6002/sdb1 100
    # swift-ring-builder container.builder add z1-192.168.0.15:6001/sdb1 100
    # swift-ring-builder object.builder add z1-192.168.0.15:6000/sdb1 100

    # swift-ring-builder account.builder add z1-192.168.0.16:6002/sdb1 100
    # swift-ring-builder container.builder add z1-192.168.0.16:6001/sdb1 100
    # swift-ring-builder object.builder add z1-192.168.0.16:6000/sdb1 100
</pre>

<p>
Verificar el contenido de los anillos ring:
</p>

<pre>
   # cd /etc/swift/

   # swift-ring-builder account.builder
   # swift-ring-builder container.builder
   # swift-ring-builder object.builder 

    account.builder, build version 1
    262144 partitions, 3.000000 replicas, 1 regions, 1 zones, 1 devices, 100.00 balance
    The minimum number of hours before a partition can be reassigned is 1
    Devices:    id  region  zone      ip address  port  replication ip  replication port      name weight partitions balance meta
                 0       1     1    192.168.0.16  6002    192.168.0.16              6002      sdb1 100.00          0 -100.00 

</pre>

<p>
   Rebalancear anillos: 
</p>

<pre>
    # swift-ring-builder account.builder rebalance
    # swift-ring-builder container.builder rebalance
    # swift-ring-builder object.builder rebalance
</pre>

<p>
Copiar los archivos account.ring.gz, container.ring.gz, y object.ring.gz al proxy y a cada
nodo de almacenamiento en el directorio /etc/swift.
</p>

<p>
    Asegurar que el usuario swift es el due&ntilde;o de los archivos de configuraci&oacute;n:
</p>

<pre>
   # chown -R swift:swift /etc/swift 
</pre>


<p>Reiniciar el  servicio: </p>
<pre>
    #service swift-proxy stop
    #service swift-proxy start 
</pre>

<p>
Iniciar el servicio en los nodos de almacenamiento
</p>

<pre>
    # swift-init all start
</pre>

<h4> Verificar la instalaci&oacute;n </h4>

<p>
Ejecutar el siguiente comando desde el proyx server:
 
</p>


<pre>
  #swift stat  
   Account: AUTH_fe13b472ad9e43e2aa8c71e7cc1c5f7c
Containers: 0
   Objects: 0
     Bytes: 0
Content-Type: text/plain; charset=utf-8
X-Timestamp: 1402842465.82440
X-Put-Timestamp: 1402842465.82440
    
</pre>


<p>
     crear y subir  un archivo  test.txt
</p>


<pre>
    $echo "this is a test" > test.txt
    $swift upload myfiles test.txt 

    $swift download myfiles  
</pre>
