<p>
    <a href="http://www.vagrantup.com/"> Vagrant </a> es una herramienta de software libre para crear
    entornos virtuales de desarrollo. En esta gu&iacute;a crearemos una m&aacute;quina virtual Ubuntu para 
    desarrollo django y la provisionaremos con   <a href="http://www.maigfrga.ntweb.co/introduccion-chef-server/"> chef</a>
</p>

<h3> Instalar VirtualBox</h3>
<p>
    Vagrant soporta diversos sistemas de virtualizaci&oacute;n. El recomendado es virtualbox, se puede instalar mediante el 
    gestor de paquetes de la distribuci&oacute;n de Ubuntu:
</p>

<pre>
    $sudo apt-get install virtualbox
</pre>

<h3> Instalando Vagrant </h3>
<p>Es recomendable instalar la &uacute;ltima versi&oacute;n de su web. Las versiones del gestor de paquetes frecuentemente estan desactualizadas.
   Para instalar la &uacute;ltima versi&oacute;n ir a
  <a href="http://www.vagrantup.com/downloads.html"> http://www.vagrantup.com/downloads.html </a>. Seleccionar la versi&oacute;n para tu
  sistema, descargarla e instarla, en mi caso, Ubuntu 64 bits:
</p>
<pre>
  $sudo dpkg -i vagrant_1.6.3_x86_64.deb  
</pre>

<h3>  Agregando un box </h3>

<p>
    Antes de empezar a crear un entorno de desarrollo es necesario descargar e instalar una m&aacute;quina base (vagran box).
    La web <a href="https://vagrantcloud.com/"> Vagrant's Cloud e </a> contiene un listado actualizado de boxes</p>. En este post
    usaremos un box ubuntu:

<pre>
    $ vagrant box add hashicorp/precise64

    Vagrant is upgrading some internal state for the latest version.
    Please do not quit Vagrant at this time. While upgrading, Vagrant
    will need to copy all your boxes, so it will use a considerable
    amount of disk space. After it is done upgrading, the temporary disk
    space will be freed.

    Press ctrl-c now to exit if you want to remove some boxes or free
    up some disk space.

    Press any other key to continue.
    ==> box: Loading metadata for box 'hashicorp/precise64'
        box: URL: https://vagrantcloud.com/hashicorp/precise64
    This box can work with multiple providers! The providers that it
    can work with are listed below. Please review the list and choose
    the provider you will be working with.

    1) hyperv
    2) virtualbox
    3) vmware_fusion
    Enter your choice: 2
    ==> box: Adding box 'hashicorp/precise64' (v1.1.0) for provider: virtualbox
        box: Downloading: https://vagrantcloud.com/hashicorp/precise64/version/2/provider/virtualbox.box
    ==> box: Successfully added box 'hashicorp/precise64' (v1.1.0) for 'virtualbox'!
</pre>


<h3>Crear un entorno de desarrollo django en Ubuntu </h3>
<p>
    Se puede crear una nueva m&aquina en segundos con el comando <code> vagrant init</code>
</p>
<pre>
    $vagrant init

    A `Vagrantfile` has been placed in this directory. You are now    
    ready to `vagrant up` your first virtual environment! Please read
    the comments in the Vagrantfile as well as documentation on
    `vagrantup.com` for more information on using Vagrant.
</pre>

<p>Este comando crea un archivo llamado Vagrantfile. Debemos editarlo con el fin de configurar la m&aacute;quina de acuerdo a nuestras necesidades.
Lo primero que tenemos que hacer es decirle a vagrant que queremos que esta m&aacute;quina sea Ubuntu, debemos buscar la opcion
 config.vm.box  y editarla:

</p>

<pre>
    config.vm.box = "hashicorp/precise64"
</pre>


<h3> Levantar la m&aacute;quina y conectarse por SSh</h3>

<pre>
    $vagrant up

    Bringing machine 'default' up with 'virtualbox' provider...
    ==> default: Importing base box 'hashicorp/precise64'...
    ==> default: Matching MAC address for NAT networking...
    ==> default: Checking if box 'hashicorp/precise64' is up to date...
    ==> default: Setting the name of the VM: vagrant_default_1407584461236_45519
    ==> default: Clearing any previously set network interfaces...
    ==> default: Preparing network interfaces based on configuration...
        default: Adapter 1: nat
    ==> default: Forwarding ports...
        default: 22 => 2222 (adapter 1)
    ==> default: Booting VM...
    ==> default: Waiting for machine to boot. This may take a few minutes...
        default: SSH address: 127.0.0.1:2222
        default: SSH username: vagrant
        default: SSH auth method: private key
    ==> default: Machine booted and ready!
    ==> default: Checking for guest additions in VM...
        default: The guest additions on this VM do not match the installed version of
        default: VirtualBox! In most cases this is fine, but in rare cases it can
        default: prevent things such as shared folders from working properly. If you see
        default: shared folder errors, please make sure the guest additions within the
        default: virtual machine match the version of VirtualBox you have installed on
        default: your host and reload your VM.
        default: 
        default: Guest Additions Version: 4.2.0
        default: VirtualBox Version: 4.3
    ==> default: Mounting shared folders...
        default: /vagrant => /home/manuel/src/notempo/ntchef/vagrant

    $vagrant ssh
    Welcome to Ubuntu 12.04 LTS (GNU/Linux 3.2.0-23-generic x86_64)

     * Documentation:  https://help.ubuntu.com/
    Welcome to your Vagrant-built virtual machine.
    Last login: Fri Sep 14 06:23:18 2012 from 10.0.2.2
</pre>

<h3> Synced Folders</h3>

<p> You can tell vagrant which or your local folders do you want to by synchronized on your virtual machine. In this example we will setup the
local directory ~/src/django whre will be a simple django project. In order to setup this directory you have to stop your localbox with
<code>vagrant halt </code> and edit Vagrantfile . Find the option   config.vm.synced_folder and mofidy it, the first argument is where your
local directory is and the second where will be synchronized on the local box:
</p>

<pre>
      config.vm.synced_folder "~/src/django", "/vagrant_data"
</pre>

<h3>Provisioning </h3>

<p>
    La siguiente lista contiene las herramientas/frameworks/librerias necesarias par aconfigurar un box para desarrollo
    django:
</p>

<ul>
    <li> Python</li>
    <li> Python virtual env with django framework and postgresql driver </li>
    <li> Postgresql db</li>
    <li> Supervisor</li>
</ul>




<h4>Django vagrant chef</h4>
<p> Chef es un framwork para automatizaci&oacute;n de infraestructuras en la nube. Puedes encontrar un post introductiorio  
    <a href="http://www.maigfrga.ntweb.co/introduccion-chef-server/"> en este enlace.</a>. Usaremos chef para configurar
    nuestra m&aacute;quina virtual, de esta forma, cada vez que iniciamos la m&aacute;quina chef se ejecutara y buscara por cambios
    en configuraci&oacute;n e infraestructura, de existir cambios los aplicara automaticamente.
   </p>

<p> <a href="https://github.com/maigfrga/django-vagrant-chef"> Django vagrant chef </a> es un projecto de chef que contiene
recetas para configurar una m&aacute;quina ubuntu para desarrollo django/postresql . 
<a href="https://github.com/maigfrga/django-vagrant-chef/blob/master/README.md"> En este enlace la documentaci&oacute;n  </a>
</p>

<pre>
    $cd ~/src
    $git clone https://github.com/maigfrga/django-vagrant-chef.git

</pre>

<h5>Atributos Django vagrant chefs</h5>

<p>Python attributes:</p>


<pre>
    ['python']['install_method'] = 'package'
    ['python']['venv_dir'] = '/svr/env/'
</pre>


<p>Postgresql attributes </p>
<pre>
    ['django_postgresql']['database'] = ''
    ['django_postgresql']['user'] = ''
    ['django_postgresql']['password'] = ''

</pre>

<p>Paquetes que seran instalados en  virtualenv</p>

<pre>
['django']['python']['packages'] = ["ipdb", "http2"]
</pre>

<p>Django app</p>

<pre>
    ['django']['app']['project_home'] = '/vagrant_data/project'
    ['django']['app']['settings'] = 'project.settings'
    ['django']['app']['port'] = '8080'
</pre>

<p>Supervisor </p>

<pre>
    ['supervisor']['inet_username'] = ''
    ['supervisor']['inet_password'] = ''
</pre>

<h4> Configurando vagrant para usar Django vagrant chef </h4>

<p>
    Instalar plugin omnibus que busca dependencias chef
</p>

<pre>
  $vagrant plugin install vagrant-omnibus  
  $vagrant plugin install vagrant-librarian-chef
</pre>

<p>
    Editar Vagrantfile, definir la ubicaci&oacute;n del proyecto  django-vagran-chef project:
</p>

<pre>
  config.omnibus.chef_version = :latest
  config.librarian_chef.cheffile_dir = '~/src/django-vagrant-chef'
  config.vm.provision "chef_solo" do |chef|
    chef.cookbooks_path = ["~/src/django-vagrant-chef/cookbooks", "~/src/django-vagrant-chef/site-cookbooks"]
    chef.roles_path = "~/src/django-vagrant-chef/roles"
    chef.data_bags_path = "~/src/django-vagrant-chef/data_bags"
    chef.add_role('django')
      chef.json = {
        "postgresql" => {
          "password" => {
            "postgres" => "iloverandompasswordsbutthiswilldo"
          }
        },
        "python" => {
            "install_method" => "package",
            "venv_dir" => "/svr/env/",
        },
        "django" => {
            "python" => {
                "packages" => ["ipdb", "http2"]
            },
            "app" => {
                "project_home" => "/vagrant_data/project",
                "settings" => "project.settings",
                "port" => "8080"

           }
        },
        "supervisor" => {
            "inet_username" => "manuel",
            "inet_password" => "manuel"
        }
      }
  end
</pre>

<h3> Networking</h3>

<p>
    Le asignaremos una ip privada a la m&aacute;quina para que la podamos acceder desde nuestro localhost.
     <a href="http://docs.vagrantup.com/v2/networking/index.html">Documentaci&oacute;n vagrant networking</a>
</p>


<h4> Configurando una red privada </h4>

<pre>
    config.vm.network "private_network", ip: "192.168.33.10"
</pre>

<h3>Recargando la box</h3>
<p>
    Cada vez que se inica la m&aacutequina con el comando
    <code>vagrant up </code> , los cambios en configuraci&oacute;n son aplicados, si la m&aacute;quina esta arriba se puede
    recargar la configuracion con el comando <code> vagran reload --provision </code>
</p>


<h3> Referencias</h3>
<ul>
    <li> Vagrant's website: <a href="http://www.vagrantup.com/">http://www.vagrantup.com/ </a>  </li>
</ul>
